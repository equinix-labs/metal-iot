## MQTT-connector for OpenFaaS

The MQTT-Connector is used to trigger functions and services in response to messages generated by the event source. It runs inside the Kubernetes cluster and is private with no ingress.

The topic is `drone-position`.

```sh
git clone https://github.com/openfaas-incubator/mqtt-connector
cd mqtt-connector
```

Edit `chart/mqtt-connector/values.yaml`

* Set `trimChannelKey:` to `false`
* Set `topic:` - replace `CHANNEL_KEY` with the value from the previous step, for example: `i-Xrxb7mpm-bs5LVY3jDU_kcE2XAgnyY/drone-position/`
* Set `broker:` to `tcp://emitter:8080`

For example:

Apply the changes:

```sh
cd mqtt-connector
cd chart

export PATH=$PATH:~/.k3sup/bin/

helm template -n openfaas --namespace openfaas mqtt-connector/ --values mqtt-connector/values.yaml | kubectl apply -f -
```

Check the logs:

```sh
kubectl logs -n openfaas deployment.apps/openfaas-mqtt-connector -f

2019/12/13 17:05:43 Topic: i-Xrxb7mpm-bs5LVY3jDU_kcE2XAgnyY/drone-position/     Broker: tcp://emitter:8080
```

Feel free to try publishing a message:

* Create `publisher.py`

```python
import paho.mqtt.publish as publish
import paho.mqtt.client as mqtt
import os, json

def on_publish(client,userdata,result):
    print("data published \n")
    pass

client = mqtt.Client("127.0.0.1:8081", transport="websockets")

client.on_publish = on_publish
broker = "127.0.0.1"
port = 8081

client.connect(broker, port)

payload = json.dumps({"name": "Carpark-watch", "tempCelsius": 3.5, "location": {"lat": 52.5740072, "lon": -0.2399354}, "batteryMv": 2700})

ret = client.publish(os.getenv("CHANNEL_KEY"), payload)
print(ret)
```

* Make sure the emitter is port-forwarded:

```sh
kubectl port-forward -n openfaas svc/emitter 8081:8080
```

* Run the publisher

```sh
# Install the MQTT broker library
sudo pip3 install paho-mqtt  # Alternatively use `pip`

export CHANNEL_KEY="i-Xrxb7mpm-bs5LVY3jDU_kcE2XAgnyY/drone-position/?ttl=1200" # as per values.yaml

python3 ./publisher.py       # Alternatively use `python`
```

You should see this message:

```sh
2019/12/13 17:07:16 Invoking (http://gateway.openfaas:8080) on topic: "drone-position/", value: "{\"name\": \"Carpark-watch\", \"tempCelsius\": 3.5, \"location\": {\"lat\": 52.5740072, \"lon\": -0.2399354}, \"batteryMv\": 2700}"
2019/12/13 17:07:16 Invoke function: db-inserter.openfaas-fn
[200] drone-position/ => db-inserter.openfaas-fn
{"status":"OK"}
2019/12/13 17:07:16 connector-sdk got result: [200] drone-position/ => db-inserter.openfaas-fn (15) bytes
2019/12/13 17:07:16 tester got result: [200] drone-position/ => db-inserter.openfaas-fn (15) bytes
```
